<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Voice Sync Pro</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* ============ MODERN CSS ============ */
        :root {
            --primary: #2563eb;
            --danger: #ef4444;
            --success: #22c55e;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        .container {
            background: var(--card);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transition: all 0.3s ease;
        }

        h1 { margin: 0 0 10px 0; font-weight: 800; letter-spacing: -1px; }
        p { color: #64748b; margin-bottom: 25px; line-height: 1.5; }

        /* Buttons */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            margin: 8px 0;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.1s, opacity 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.96); }
        button.secondary { background-color: #e2e8f0; color: #475569; }
        button.danger { background-color: var(--danger); }
        
        /* Pulse Animation for Recording */
        button.recording {
            background-color: var(--danger);
            animation: pulse-red 1.5s infinite;
        }

        /* Inputs */
        input {
            width: 100%;
            padding: 16px;
            box-sizing: border-box;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 24px;
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* Utility Classes */
        .hidden { display: none !important; }
        
        /* PC Display Styles */
        .code-display {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: 4px;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }

        .text-area-container {
            position: relative;
            margin-top: 20px;
        }

        .text-box {
            background: #f1f5f9;
            border-radius: 16px;
            padding: 20px;
            height: 250px;
            overflow-y: auto;
            text-align: left;
            font-size: 18px;
            line-height: 1.6;
            white-space: pre-wrap;
            border: 2px solid transparent;
        }
        
        .interim { color: #94a3b8; } /* Grey text for unfinished sentences */

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .status-wait { background: #fef3c7; color: #d97706; }
        .status-ok { background: #dcfce7; color: #166534; }
        .status-err { background: #fee2e2; color: #991b1b; }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="screen-selection">
            <h1>Select Mode</h1>
            <p>Choose your role for this device.</p>
            <button onclick="app.startPC()">üíª I am PC (Receiver)</button>
            <button class="secondary" onclick="app.startMobile()">üì± I am Mobile (Microphone)</button>
        </div>

        <div id="screen-pc" class="hidden">
            <span class="status-badge status-wait" id="pc-status">Waiting for connection...</span>
            <p style="margin-bottom: 5px;">Enter this code on mobile:</p>
            <div class="code-display" id="display-code">...</div>
            
            <div class="text-area-container">
                <div class="text-box" id="output-box">
                    <span id="final-text"></span><span id="interim-text" class="interim"></span>
                </div>
            </div>

            <div class="toolbar">
                <button class="secondary" onclick="app.copyText()">üìã Copy</button>
                <button class="danger" onclick="app.clearText()">üóëÔ∏è Clear</button>
            </div>
            <button class="secondary" onclick="location.reload()" style="margin-top: 15px; font-size: 14px;">‚Üê Back</button>
        </div>

        <div id="screen-mobile" class="hidden">
            <div id="step-connect">
                <h1>Connect</h1>
                <p>Enter the code shown on your PC screen.</p>
                <input type="number" id="input-code" placeholder="0000" maxlength="4">
                <button onclick="app.connectToPC()">üîó Connect</button>
                <button class="secondary" onclick="location.reload()">Cancel</button>
            </div>

            <div id="step-mic" class="hidden">
                <span class="status-badge status-ok">Connected to PC</span>
                <div style="height: 20px;"></div>
                <button id="btn-mic" onclick="app.toggleMic()">üé§ Start Mic</button>
                <p id="mic-status" style="margin-top: 20px; font-size: 14px;">Tap to start speaking</p>
                <p style="font-size: 12px; color: #94a3b8;">Screen will stay awake automatically.</p>
            </div>
        </div>
    </div>

    <script>
        const app = {
            peer: null,
            conn: null,
            recognition: null,
            isRecording: false,
            wakeLock: null,

            // UI Switching
            show: (id) => {
                document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            },

            // --- PC Logic ---
            startPC: () => {
                app.show('screen-pc');
                const code = Math.floor(1000 + Math.random() * 9000);
                document.getElementById('display-code').innerText = code;

                app.peer = new Peer("voice-pro-" + code);
                
                app.peer.on('connection', (c) => {
                    app.conn = c;
                    app.updateStatus('pc-status', 'Connected!', 'status-ok');

                    app.conn.on('data', (data) => {
                        // Data format: { final: "text", interim: "text" }
                        if (data.type === 'speech') {
                            document.getElementById('final-text').innerText = data.final;
                            document.getElementById('interim-text').innerText = data.interim;
                            
                            // Auto scroll to bottom
                            const box = document.getElementById('output-box');
                            box.scrollTop = box.scrollHeight;
                        }
                    });

                    app.conn.on('close', () => app.updateStatus('pc-status', 'Disconnected', 'status-err'));
                });
            },

            // --- Mobile Logic ---
            startMobile: () => {
                app.show('screen-mobile');
                app.peer = new Peer(); // Random ID
            },

            connectToPC: () => {
                const code = document.getElementById('input-code').value;
                if(code.length < 4) return alert("Please enter the 4-digit code.");

                const btn = document.querySelector('#step-connect button');
                btn.innerText = "Connecting...";
                
                app.conn = app.peer.connect("voice-pro-" + code);

                app.conn.on('open', () => {
                    document.getElementById('step-connect').classList.add('hidden');
                    document.getElementById('step-mic').classList.remove('hidden');
                    app.activateWakeLock(); // KEEP SCREEN ON
                    app.setupMic();
                });

                app.conn.on('error', () => {
                    alert("Connection failed. Check code.");
                    btn.innerText = "üîó Connect";
                });
            },

            // --- Advanced Mic Logic (iOS + Speed) ---
            setupMic: () => {
                // Support for iOS (webkit) and Android
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    alert("Speech API not supported in this browser. Please use Chrome or Safari.");
                    return;
                }

                app.recognition = new SpeechRecognition();
                // app.recognition.lang = 'ur-PK'; // Change to 'en-US' if you want English speech
                app.recognition.lang = 'ur-PK'; 
                app.recognition.continuous = true; 
                app.recognition.interimResults = true; // KEY FOR SPEED

                let finalTranscript = "";

                app.recognition.onresult = (event) => {
                    let interimTranscript = "";

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + " ";
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }

                    // Send BOTH final and interim text instantly
                    if(app.conn && app.conn.open) {
                        app.conn.send({
                            type: 'speech',
                            final: finalTranscript,
                            interim: interimTranscript
                        });
                    }
                    
                    document.getElementById('mic-status').innerText = "Listening...";
                };

                // Auto-restart for iOS quirks
                app.recognition.onend = () => {
                    if(app.isRecording) {
                        console.log("Restarting recognition...");
                        try {
                            app.recognition.start();
                        } catch(e) { console.log("Mic restart error", e); }
                    } else {
                        document.getElementById('mic-status').innerText = "Mic Stopped";
                    }
                };

                app.recognition.onerror = (event) => {
                    console.error("Speech Error:", event.error);
                    if(event.error === 'not-allowed') {
                        alert("Microphone access denied.");
                        app.toggleMic(); // Turn off UI
                    }
                };
            },

            toggleMic: () => {
                const btn = document.getElementById('btn-mic');
                
                if(!app.isRecording) {
                    // Start
                    try {
                        app.recognition.start();
                        app.isRecording = true;
                        btn.innerText = "üõë Stop Mic";
                        btn.classList.add('recording');
                        document.getElementById('mic-status').innerText = "Initializing...";
                    } catch (e) { console.error(e); }
                } else {
                    // Stop
                    app.isRecording = false;
                    app.recognition.stop();
                    btn.innerText = "üé§ Start Mic";
                    btn.classList.remove('recording');
                }
            },

            // --- Helper Features ---
            activateWakeLock: async () => {
                if ('wakeLock' in navigator) {
                    try {
                        app.wakeLock = await navigator.wakeLock.request('screen');
                        console.log("Screen Wake Lock Active");
                    } catch (err) {
                        console.log("Wake Lock Error:", err);
                    }
                }
            },

            copyText: () => {
                const text = document.getElementById('final-text').innerText + document.getElementById('interim-text').innerText;
                navigator.clipboard.writeText(text).then(() => alert("Copied!"));
            },

            clearText: () => {
                document.getElementById('final-text').innerText = "";
                document.getElementById('interim-text').innerText = "";
                // Also reset on mobile memory if needed (optional)
                // Need to restart recognition to clear internal buffer sometimes, but simple clear works for UI
                if(app.recognition) {
                   app.recognition.stop();
                   setTimeout(() => { if(app.isRecording) app.recognition.start(); }, 200);
                }
            },

            updateStatus: (id, text, className) => {
                const el = document.getElementById(id);
                el.innerText = text;
                el.className = "status-badge " + className;
            }
        };
    </script>
</body>
</html>